<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOEIC Memory Match - Firebase Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .container {
            max-width: 800px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .firebase-status {
            display: inline-block;
            padding: 5px 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            font-size: 12px;
            margin-top: 10px;
        }

        .firebase-status.connected {
            background: #28a745;
        }

        .firebase-status.disconnected {
            background: #dc3545;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .level-selector {
            padding: 20px;
            text-align: center;
        }

        .level-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .level-btn {
            padding: 15px 30px;
            font-size: 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .level-btn.easy {
            background: #28a745;
            color: white;
        }

        .level-btn.medium {
            background: #ffc107;
            color: #333;
        }

        .level-btn.hard {
            background: #dc3545;
            color: white;
        }

        .level-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .game-board {
            padding: 20px;
            display: none;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .card {
            aspect-ratio: 3/4;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            cursor: pointer;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .card:hover {
            transform: scale(1.05);
        }

        .card.flipped {
            transform: rotateY(180deg);
        }

        .card.matched {
            animation: matchAnimation 0.6s ease;
            pointer-events: none;
        }

        @keyframes matchAnimation {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
        }

        .card-front {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 40px;
        }

        .card-back {
            background: white;
            color: #333;
            font-size: 16px;
            transform: rotateY(180deg);
            border: 3px solid #667eea;
        }

        .card-back.english {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }

        .card-back.korean {
            font-size: 18px;
            color: #764ba2;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .game-over {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }

        .game-over h2 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 20px;
        }

        .game-over p {
            font-size: 18px;
            color: #6c757d;
            margin: 10px 0;
        }

        .leaderboard {
            padding: 20px;
            display: none;
        }

        .leaderboard h2 {
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
        }

        .leaderboard-tabs {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 8px;
            align-items: center;
            transition: all 0.3s;
        }

        .leaderboard-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .leaderboard-item.current-user {
            background: #fff3cd;
            border: 2px solid #ffc107;
        }

        .leaderboard-rank {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            min-width: 40px;
        }

        .leaderboard-name {
            flex: 1;
            margin-left: 15px;
            font-weight: bold;
        }

        .leaderboard-score {
            font-size: 18px;
            color: #28a745;
            font-weight: bold;
        }

        .login-section {
            padding: 40px 20px;
            text-align: center;
        }

        .login-section input {
            width: 100%;
            max-width: 300px;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #667eea;
            border-radius: 8px;
            margin: 10px 0;
        }

        .message {
            padding: 15px;
            margin: 15px 20px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #17a2b8;
        }



        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .stat-card-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-card-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        @media (max-width: 600px) {
            .cards-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }

            .card-back {
                font-size: 14px;
            }

            .card-back.english {
                font-size: 16px;
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ´ TOEIC Memory Match</h1>
            <p>ë‹¨ì–´ì™€ ëœ»ì„ ë§¤ì¹­í•˜ì„¸ìš”!</p>
            <div class="firebase-status" id="firebaseStatus">ğŸ”„ ì—°ê²° ì¤‘...</div>
        </div>

        <div class="message" id="message"></div>

        <!-- Login Section -->
        <div class="login-section" id="loginSection">
            <h2>í™˜ì˜í•©ë‹ˆë‹¤! ğŸ‘‹</h2>
            <p style="margin: 20px 0; color: #6c757d;">í•™ìƒ ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  ê²Œì„ì„ ì‹œì‘í•˜ì„¸ìš”</p>
            <input type="text" id="playerName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="20">
            <input type="text" id="studentId" placeholder="í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="20">
            <br>
            <button class="btn btn-primary" onclick="login()" style="margin-top: 20px;">ì‹œì‘í•˜ê¸° ğŸš€</button>
        </div>

        <!-- Stats Section -->
        <div class="stats" id="statsSection" style="display: none;">
            <div class="stat-item">
                <div class="stat-label">ì‹œê°„</div>
                <div class="stat-value" id="timer">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">ì ìˆ˜</div>
                <div class="stat-value" id="score">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">ë§¤ì¹­</div>
                <div class="stat-value" id="matches">0</div>
            </div>
        </div>

        <!-- Level Selector -->
        <div class="level-selector" id="levelSelector" style="display: none;">
            <h2 style="margin-bottom: 20px; color: #667eea;">ë‚œì´ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”</h2>
            <div class="level-buttons">
                <button class="level-btn easy" onclick="startGame('easy')">
                    ì´ˆê¸‰ (6ìŒ)<br>
                    <small>ê¸°ì´ˆ ë‹¨ì–´</small>
                </button>
                <button class="level-btn medium" onclick="startGame('medium')">
                    ì¤‘ê¸‰ (8ìŒ)<br>
                    <small>ì¼ë°˜ ë‹¨ì–´</small>
                </button>
                <button class="level-btn hard" onclick="startGame('hard')">
                    ê³ ê¸‰ (10ìŒ)<br>
                    <small>ê³ ë‚œë„ ë‹¨ì–´</small>
                </button>
            </div>
            <div style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="showLeaderboard()">ğŸ† ë¦¬ë”ë³´ë“œ</button>
                <button class="btn btn-secondary" onclick="showStats()">ğŸ“Š í†µê³„</button>
            </div>
        </div>

        <!-- Game Board -->
        <div class="game-board" id="gameBoard">
            <div class="cards-grid" id="cardsGrid"></div>
            <div class="controls">
                <button class="btn btn-secondary" onclick="resetGame()">ë‹¤ì‹œ ì‹œì‘</button>
                <button class="btn btn-secondary" onclick="backToMenu()">ë©”ë‰´ë¡œ</button>
            </div>
        </div>

        <!-- Game Over -->
        <div class="game-over" id="gameOver">
            <h2>ğŸ‰ ê²Œì„ ì™„ë£Œ!</h2>
            <p>ê±¸ë¦° ì‹œê°„: <span id="finalTime"></span>ì´ˆ</p>
            <p>ìµœì¢… ì ìˆ˜: <span id="finalScore"></span>ì </p>
            <p id="rankMessage"></p>
            <div class="controls">
                <button class="btn btn-primary" onclick="resetGame()">ë‹¤ì‹œ í•˜ê¸°</button>
                <button class="btn btn-secondary" onclick="backToMenu()">ë©”ë‰´ë¡œ</button>
                <button class="btn btn-secondary" onclick="showLeaderboard()">ğŸ† ë¦¬ë”ë³´ë“œ</button>
            </div>
        </div>

        <!-- Leaderboard -->
        <div class="leaderboard" id="leaderboard">
            <h2>ğŸ† ë¦¬ë”ë³´ë“œ</h2>
            <div class="leaderboard-tabs">
                <button class="tab-btn active" onclick="changeLeaderboardTab('all')">ì „ì²´</button>
                <button class="tab-btn" onclick="changeLeaderboardTab('easy')">ğŸŸ¢ ì´ˆê¸‰</button>
                <button class="tab-btn" onclick="changeLeaderboardTab('medium')">ğŸŸ¡ ì¤‘ê¸‰</button>
                <button class="tab-btn" onclick="changeLeaderboardTab('hard')">ğŸ”´ ê³ ê¸‰</button>
            </div>
            <div id="leaderboardList"></div>
            <div class="controls" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="backToMenu()">ë©”ë‰´ë¡œ</button>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-overview" id="statsOverview" style="display: none;">
            <div class="stat-card">
                <div class="stat-card-value" id="totalPlayers">0</div>
                <div class="stat-card-label">ì´ í”Œë ˆì´ì–´</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-value" id="totalGames">0</div>
                <div class="stat-card-label">ì´ ê²Œì„ ìˆ˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-value" id="avgScore">0</div>
                <div class="stat-card-label">í‰ê·  ì ìˆ˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-value" id="topScore">0</div>
                <div class="stat-card-label">ìµœê³  ì ìˆ˜</div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // TOEIC ë‹¨ì–´ ë°ì´í„°ë² ì´ìŠ¤
        const wordDatabase = {
            easy: [
                { english: 'account', korean: 'ê³„ì¢Œ, ì„¤ëª…' },
                { english: 'benefit', korean: 'ì´ìµ, í˜œíƒ' },
                { english: 'client', korean: 'ê³ ê°, ì˜ë¢°ì¸' },
                { english: 'deliver', korean: 'ë°°ë‹¬í•˜ë‹¤' },
                { english: 'employee', korean: 'ì§ì›' },
                { english: 'facility', korean: 'ì‹œì„¤' },
                { english: 'schedule', korean: 'ì¼ì •' },
                { english: 'manager', korean: 'ê´€ë¦¬ì' },
                { english: 'payment', korean: 'ì§€ë¶ˆ' },
                { english: 'service', korean: 'ì„œë¹„ìŠ¤' },
                { english: 'product', korean: 'ì œí’ˆ' },
                { english: 'office', korean: 'ì‚¬ë¬´ì‹¤' }
            ],
            medium: [
                { english: 'accomplish', korean: 'ì„±ì·¨í•˜ë‹¤' },
                { english: 'adequate', korean: 'ì ì ˆí•œ' },
                { english: 'allocate', korean: 'í• ë‹¹í•˜ë‹¤' },
                { english: 'budget', korean: 'ì˜ˆì‚°' },
                { english: 'consumer', korean: 'ì†Œë¹„ì' },
                { english: 'deadline', korean: 'ë§ˆê°ì¼' },
                { english: 'expense', korean: 'ë¹„ìš©' },
                { english: 'implement', korean: 'ì‹¤í–‰í•˜ë‹¤' },
                { english: 'negotiate', korean: 'í˜‘ìƒí•˜ë‹¤' },
                { english: 'proposal', korean: 'ì œì•ˆì„œ' },
                { english: 'revenue', korean: 'ìˆ˜ìµ' },
                { english: 'strategy', korean: 'ì „ëµ' },
                { english: 'purchase', korean: 'êµ¬ë§¤í•˜ë‹¤' },
                { english: 'inventory', korean: 'ì¬ê³ ' }
            ],
            hard: [
                { english: 'acquisition', korean: 'ì¸ìˆ˜, íšë“' },
                { english: 'benchmark', korean: 'ê¸°ì¤€ì ' },
                { english: 'comprehensive', korean: 'í¬ê´„ì ì¸' },
                { english: 'deteriorate', korean: 'ì•…í™”ë˜ë‹¤' },
                { english: 'elaborate', korean: 'ì •êµí•œ' },
                { english: 'fluctuate', korean: 'ë³€ë™í•˜ë‹¤' },
                { english: 'infrastructure', korean: 'ê¸°ë°˜ì‹œì„¤' },
                { english: 'jurisdiction', korean: 'ê´€í• ê¶Œ' },
                { english: 'leverage', korean: 'ì˜í–¥ë ¥' },
                { english: 'merger', korean: 'í•©ë³‘' },
                { english: 'obsolete', korean: 'êµ¬ì‹ì˜' },
                { english: 'preliminary', korean: 'ì˜ˆë¹„ì˜' },
                { english: 'reconcile', korean: 'ì¡°ì •í•˜ë‹¤' },
                { english: 'subsidiary', korean: 'ìíšŒì‚¬' },
                { english: 'terminate', korean: 'ì¢…ë£Œí•˜ë‹¤' }
            ]
        };

        // Firebase ì„¤ì • (ì—¬ê¸°ì— ì‹¤ì œ Firebase í”„ë¡œì íŠ¸ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”)
        const firebaseConfig = {
            apiKey: "AIzaSyBkk4hv2lV4xa0rxZWa8rGMtVCsv_IhU_g",
  authDomain: "toeic-study-4c3e6.firebaseapp.com",
  databaseURL: "https://toeic-study-4c3e6-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "toeic-study-4c3e6",
  storageBucket: "toeic-study-4c3e6.firebasestorage.app",
  messagingSenderId: "5466579220",
  appId: "1:5466579220:web:9e2342fb5c08e2f628a201"
        };

        // Firebase ë° ê²Œì„ ìƒíƒœ
        let firebaseApp = null;
        let database = null;
        let currentLeaderboardTab = 'all';
        
        let gameState = {
            playerName: '',
            studentId: '',
            userId: '',
            currentLevel: '',
            cards: [],
            flippedCards: [],
            matchedPairs: 0,
            score: 0,
            timeElapsed: 0,
            timerInterval: null,
            moves: 0
        };

        // Firebase ì´ˆê¸°í™” (ìë™ ì‹¤í–‰)
        function initializeFirebase() {
            try {
                // Firebase ì´ˆê¸°í™”
                firebaseApp = firebase.initializeApp(firebaseConfig);
                database = firebase.database();

                // ì—°ê²° í…ŒìŠ¤íŠ¸
                database.ref('.info/connected').on('value', (snapshot) => {
                    if (snapshot.val() === true) {
                        document.getElementById('firebaseStatus').textContent = 'âœ… ì—°ê²°ë¨';
                        document.getElementById('firebaseStatus').className = 'firebase-status connected';
                    } else {
                        document.getElementById('firebaseStatus').textContent = 'âŒ ì—°ê²° ëŠê¹€';
                        document.getElementById('firebaseStatus').className = 'firebase-status disconnected';
                    }
                });

            } catch (error) {
                console.error('Firebase initialization error:', error);
                document.getElementById('firebaseStatus').textContent = 'âš ï¸ ì˜¤í”„ë¼ì¸ ëª¨ë“œ';
                document.getElementById('firebaseStatus').className = 'firebase-status disconnected';
                // Firebase ì—†ì´ë„ ê²Œì„ ì§„í–‰ ê°€ëŠ¥
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ Firebase ìë™ ì´ˆê¸°í™”
        window.onload = function() {
            initializeFirebase();
        };

        // ë¡œê·¸ì¸
        function login() {
            const name = document.getElementById('playerName').value.trim();
            const studentId = document.getElementById('studentId').value.trim();
            
            if (!name) {
                showMessage('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!', 'error');
                return;
            }

            if (!studentId) {
                showMessage('í•™ë²ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”!', 'error');
                return;
            }
            
            gameState.playerName = name;
            gameState.studentId = studentId;
            gameState.userId = studentId; // í•™ë²ˆì„ ê³ ìœ  IDë¡œ ì‚¬ìš©
            
            // Firebaseì— ì‚¬ìš©ì ì •ë³´ ì €ì¥/ì—…ë°ì´íŠ¸ (ì—°ê²°ë˜ì–´ ìˆìœ¼ë©´)
            if (database) {
                database.ref('users/' + gameState.userId).update({
                    name: name,
                    studentId: studentId,
                    lastLogin: firebase.database.ServerValue.TIMESTAMP
                }).catch(err => {
                    console.log('Firebase ì €ì¥ ì‹¤íŒ¨ (ì˜¤í”„ë¼ì¸ ëª¨ë“œ):', err);
                });
            }
            
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('levelSelector').style.display = 'block';
            document.getElementById('statsSection').style.display = 'flex';
            
            showMessage(`í™˜ì˜í•©ë‹ˆë‹¤, ${name}ë‹˜! ğŸ‰`, 'success');
        }

        // ë©”ì‹œì§€ í‘œì‹œ
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 3000);
        }

        // ê²Œì„ ì‹œì‘
        function startGame(level) {
            gameState.currentLevel = level;
            gameState.matchedPairs = 0;
            gameState.score = 0;
            gameState.timeElapsed = 0;
            gameState.moves = 0;
            gameState.flippedCards = [];
            
            const pairCount = level === 'easy' ? 6 : level === 'medium' ? 8 : 10;
            const words = getRandomWords(level, pairCount);
            
            createCards(words);
            
            document.getElementById('levelSelector').style.display = 'none';
            document.getElementById('gameBoard').style.display = 'block';
            document.getElementById('gameOver').style.display = 'none';
            
            updateStats();
            startTimer();
        }

        // ëœë¤ ë‹¨ì–´ ì„ íƒ
        function getRandomWords(level, count) {
            const allWords = [...wordDatabase[level]];
            const selected = [];
            
            for (let i = 0; i < count; i++) {
                const randomIndex = Math.floor(Math.random() * allWords.length);
                selected.push(allWords.splice(randomIndex, 1)[0]);
            }
            
            return selected;
        }

        // ì¹´ë“œ ìƒì„±
        function createCards(words) {
            const cards = [];
            
            words.forEach((word, index) => {
                cards.push({
                    id: `eng-${index}`,
                    type: 'english',
                    text: word.english,
                    pair: index
                });
            });
            
            words.forEach((word, index) => {
                cards.push({
                    id: `kor-${index}`,
                    type: 'korean',
                    text: word.korean,
                    pair: index
                });
            });
            
            shuffleArray(cards);
            gameState.cards = cards;
            
            renderCards();
        }

        // ë°°ì—´ ì„ê¸°
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // ì¹´ë“œ ë Œë”ë§
        function renderCards() {
            const grid = document.getElementById('cardsGrid');
            grid.innerHTML = '';
            
            gameState.cards.forEach((card, index) => {
                const cardEl = document.createElement('div');
                cardEl.className = 'card';
                cardEl.dataset.index = index;
                cardEl.onclick = () => flipCard(index);
                
                cardEl.innerHTML = `
                    <div class="card-face card-front">ğŸ´</div>
                    <div class="card-face card-back ${card.type}">
                        ${card.text}
                    </div>
                `;
                
                grid.appendChild(cardEl);
            });
        }

        // ì¹´ë“œ ë’¤ì§‘ê¸°
        function flipCard(index) {
            const card = gameState.cards[index];
            const cardEl = document.querySelectorAll('.card')[index];
            
            if (cardEl.classList.contains('flipped') || cardEl.classList.contains('matched')) {
                return;
            }
            
            if (gameState.flippedCards.length >= 2) {
                return;
            }
            
            cardEl.classList.add('flipped');
            gameState.flippedCards.push({ index, card });
            
            if (gameState.flippedCards.length === 2) {
                gameState.moves++;
                setTimeout(checkMatch, 800);
            }
        }

        // ë§¤ì¹­ ì²´í¬
        function checkMatch() {
            const [first, second] = gameState.flippedCards;
            const firstEl = document.querySelectorAll('.card')[first.index];
            const secondEl = document.querySelectorAll('.card')[second.index];
            
            if (first.card.pair === second.card.pair) {
                firstEl.classList.add('matched');
                secondEl.classList.add('matched');
                
                gameState.matchedPairs++;
                gameState.score += 100;
                
                showMessage('ë§ì•˜ìŠµë‹ˆë‹¤! ğŸ‰', 'success');
                updateStats();
                
                if (gameState.matchedPairs === gameState.cards.length / 2) {
                    setTimeout(endGame, 500);
                }
            } else {
                firstEl.classList.remove('flipped');
                secondEl.classList.remove('flipped');
            }
            
            gameState.flippedCards = [];
        }

        // íƒ€ì´ë¨¸ ì‹œì‘
        function startTimer() {
            gameState.timerInterval = setInterval(() => {
                gameState.timeElapsed++;
                updateStats();
            }, 1000);
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            document.getElementById('timer').textContent = gameState.timeElapsed;
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('matches').textContent = `${gameState.matchedPairs}/${gameState.cards.length / 2}`;
        }

        // ê²Œì„ ì¢…ë£Œ
        async function endGame() {
            clearInterval(gameState.timerInterval);
            
            const timeBonus = Math.max(0, 300 - gameState.timeElapsed * 2);
            gameState.score += timeBonus;
            
            document.getElementById('finalTime').textContent = gameState.timeElapsed;
            document.getElementById('finalScore').textContent = gameState.score;
            
            // Firebaseì— ì ìˆ˜ ì €ì¥
            await saveScoreToFirebase();
            
            document.getElementById('gameBoard').style.display = 'none';
            document.getElementById('gameOver').style.display = 'block';
            
            showMessage('ê²Œì„ ì™„ë£Œ! ğŸŠ', 'success');
        }

        // Firebaseì— ì ìˆ˜ ì €ì¥
        async function saveScoreToFirebase() {
            if (!database) {
                // Firebase ì—†ìœ¼ë©´ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
                const localScores = JSON.parse(localStorage.getItem('toeic_scores') || '[]');
                localScores.push({
                    userId: gameState.userId,
                    name: gameState.playerName,
                    studentId: gameState.studentId,
                    score: gameState.score,
                    time: gameState.timeElapsed,
                    level: gameState.currentLevel,
                    moves: gameState.moves,
                    timestamp: new Date().getTime()
                });
                localScores.sort((a, b) => b.score - a.score);
                localStorage.setItem('toeic_scores', JSON.stringify(localScores.slice(0, 100)));
                return;
            }

            const scoreData = {
                userId: gameState.userId,
                name: gameState.playerName,
                studentId: gameState.studentId,
                score: gameState.score,
                time: gameState.timeElapsed,
                level: gameState.currentLevel,
                moves: gameState.moves,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            try {
                // scores ì»¬ë ‰ì…˜ì— ì €ì¥
                const newScoreRef = database.ref('scores').push();
                await newScoreRef.set(scoreData);

                // ì‚¬ìš©ìë³„ ìµœê³  ì ìˆ˜ ì—…ë°ì´íŠ¸
                const userScoresRef = database.ref(`userScores/${gameState.userId}/${gameState.currentLevel}`);
                const snapshot = await userScoresRef.once('value');
                const currentBest = snapshot.val();

                if (!currentBest || gameState.score > currentBest.score) {
                    await userScoresRef.set(scoreData);
                }

                showMessage('ì ìˆ˜ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰', 'success');
            } catch (error) {
                console.error('Score save error:', error);
                showMessage('ì ìˆ˜ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ë¦¬ë”ë³´ë“œ í‘œì‹œ
        async function showLeaderboard() {
            document.getElementById('levelSelector').style.display = 'none';
            document.getElementById('gameBoard').style.display = 'none';
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('leaderboard').style.display = 'block';
            
            await loadLeaderboard(currentLeaderboardTab);
        }

        // ë¦¬ë”ë³´ë“œ íƒ­ ë³€ê²½
        function changeLeaderboardTab(tab) {
            currentLeaderboardTab = tab;
            
            // íƒ­ ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            loadLeaderboard(tab);
        }

        // ë¦¬ë”ë³´ë“œ ë¡œë“œ
        async function loadLeaderboard(level) {
            const list = document.getElementById('leaderboardList');
            list.innerHTML = '<div class="loading"><div class="spinner"></div><p>ë¡œë”© ì¤‘...</p></div>';

            if (!database) {
                // ì˜¤í”„ë¼ì¸ ëª¨ë“œ: ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¡œë“œ
                const localScores = JSON.parse(localStorage.getItem('toeic_scores') || '[]');
                let filteredScores = localScores;
                
                if (level !== 'all') {
                    filteredScores = localScores.filter(s => s.level === level);
                }
                
                list.innerHTML = '';
                
                if (filteredScores.length === 0) {
                    list.innerHTML = '<p style="text-align: center; padding: 40px; color: #6c757d;">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    displayLeaderboardItems(filteredScores.slice(0, 20), list);
                }
                return;
            }

            try {
                let query;
                if (level === 'all') {
                    query = database.ref('scores').orderByChild('score').limitToLast(50);
                } else {
                    query = database.ref('scores').orderByChild('level').equalTo(level).limitToLast(50);
                }

                const snapshot = await query.once('value');
                const scores = [];

                snapshot.forEach((childSnapshot) => {
                    scores.push(childSnapshot.val());
                });

                // ì ìˆ˜ ìˆœìœ¼ë¡œ ì •ë ¬
                scores.sort((a, b) => b.score - a.score);

                list.innerHTML = '';

                if (scores.length === 0) {
                    list.innerHTML = '<p style="text-align: center; padding: 40px; color: #6c757d;">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    displayLeaderboardItems(scores.slice(0, 20), list);
                }
            } catch (error) {
                console.error('Leaderboard load error:', error);
                list.innerHTML = '<p style="text-align: center; padding: 40px; color: #dc3545;">ë¦¬ë”ë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        }

        // ë¦¬ë”ë³´ë“œ ì•„ì´í…œ í‘œì‹œ (ê³µí†µ í•¨ìˆ˜)
        function displayLeaderboardItems(scores, listElement) {
            scores.forEach((score, index) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                
                if (score.userId === gameState.userId) {
                    item.classList.add('current-user');
                }
                
                let medal = '';
                if (index === 0) medal = 'ğŸ¥‡';
                else if (index === 1) medal = 'ğŸ¥ˆ';
                else if (index === 2) medal = 'ğŸ¥‰';
                
                const levelBadge = score.level === 'easy' ? 'ğŸŸ¢' : score.level === 'medium' ? 'ğŸŸ¡' : 'ğŸ”´';
                
                item.innerHTML = `
                    <div class="leaderboard-rank">${medal || (index + 1)}</div>
                    <div class="leaderboard-name">
                        ${score.name}
                        ${score.studentId ? `<br><small style="color: #6c757d;">${score.studentId}</small>` : ''}
                    </div>
                    <div>
                        ${levelBadge}
                        <div class="leaderboard-score">${score.score}ì </div>
                        <small style="color: #6c757d;">${score.time}ì´ˆ</small>
                    </div>
                `;
                listElement.appendChild(item);
            });
        }

        // í†µê³„ ë³´ê¸°
        async function showStats() {
            document.getElementById('levelSelector').style.display = 'none';
            document.getElementById('statsOverview').style.display = 'grid';

            if (!database) {
                // ì˜¤í”„ë¼ì¸ ëª¨ë“œ
                const localScores = JSON.parse(localStorage.getItem('toeic_scores') || '[]');
                const uniqueUsers = new Set(localScores.map(s => s.userId));
                
                document.getElementById('totalPlayers').textContent = uniqueUsers.size;
                document.getElementById('totalGames').textContent = localScores.length;
                
                if (localScores.length > 0) {
                    const totalScore = localScores.reduce((sum, s) => sum + s.score, 0);
                    const avgScore = Math.round(totalScore / localScores.length);
                    const maxScore = Math.max(...localScores.map(s => s.score));
                    
                    document.getElementById('avgScore').textContent = avgScore;
                    document.getElementById('topScore').textContent = maxScore;
                } else {
                    document.getElementById('avgScore').textContent = 0;
                    document.getElementById('topScore').textContent = 0;
                }
                return;
            }

            try {
                // ì´ í”Œë ˆì´ì–´ ìˆ˜
                const usersSnapshot = await database.ref('users').once('value');
                const totalPlayers = usersSnapshot.numChildren();
                document.getElementById('totalPlayers').textContent = totalPlayers;

                // ì´ ê²Œì„ ìˆ˜
                const scoresSnapshot = await database.ref('scores').once('value');
                const totalGames = scoresSnapshot.numChildren();
                document.getElementById('totalGames').textContent = totalGames;

                // í‰ê·  ì ìˆ˜ ë° ìµœê³  ì ìˆ˜
                let totalScore = 0;
                let maxScore = 0;
                scoresSnapshot.forEach((child) => {
                    const score = child.val().score;
                    totalScore += score;
                    if (score > maxScore) maxScore = score;
                });

                const avgScore = totalGames > 0 ? Math.round(totalScore / totalGames) : 0;
                document.getElementById('avgScore').textContent = avgScore;
                document.getElementById('topScore').textContent = maxScore;

            } catch (error) {
                console.error('Stats load error:', error);
                showMessage('í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ê²Œì„ ë¦¬ì…‹
        function resetGame() {
            clearInterval(gameState.timerInterval);
            startGame(gameState.currentLevel);
        }

        // ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°
        function backToMenu() {
            clearInterval(gameState.timerInterval);
            document.getElementById('gameBoard').style.display = 'none';
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('leaderboard').style.display = 'none';
            document.getElementById('statsOverview').style.display = 'none';
            document.getElementById('levelSelector').style.display = 'block';
        }
    </script>
</body>
</html>